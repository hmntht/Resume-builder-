<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Resume Redesigner</title>
    <!-- Load Tailwind CSS (CRITICAL) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, ReactDOM, and Babel (CRITICAL for running JSX in the browser) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Define the font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom print styling to ensure the resume looks good when saved as PDF */
        @media print {
            .printable { 
                max-width: 210mm; 
                margin: 0; 
                padding: 0; 
                box-shadow: none; 
            }
            body { 
                /* Ensures background colors and styles print correctly */
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
            }
        }
    </style>
</head>
<body>

    <!-- This is the root element where the React app will be rendered -->
    <div id="root"></div>

    <script type="text/babel">
        // Start of React/JSX Code
        
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // Icon Components (Simplified SVGs for compatibility)
        const RefreshCcw = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-7.44 3.42"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 7.44-3.42"/><path d="M17.65 6.35L21 3M3 21l3.35-3.35"/></svg>;
        const Send = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>;
        const Download = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const Loader2 = ({ className }) => <svg className={`${className} animate-spin`} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Edit = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const Printer = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>;
        const CheckCircle = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const Smartphone = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>;
        const Mail = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>;
        const Globe = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 0 4 10 15.3 15.3 0 0 0-4 10 15.3 15.3 0 0 0-4-10 15.3 15.3 0 0 0 4-10zM2.05 9h19.9"/></svg>;
        const Briefcase = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const GraduationCap = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6m-2-4v6m-2-4v6M5 17l5-3 5 3"/><path d="M12 3a7 7 0 0 0-7 7v6a7 7 0 0 0 7 7 7 7 0 0 0 7-7v-6a7 7 0 0 0-7-7z"/></svg>;
        const Zap = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const UploadCloud = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>;
        const FileText = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>;
        const ImageIcon = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;


        // --- CONFIGURATION AND CONSTANTS ---

        // gemini-2.5-flash-preview-09-2025 supports multimodal input (text and image)
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025'; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent`;
        const apiKey = ""; // API key is handled by the environment

        // Define the structured JSON schema for the AI output
        const RESUME_SCHEMA = {
            type: "OBJECT",
            properties: {
                parsedData: {
                    type: "OBJECT",
                    properties: {
                        name: { "type": "STRING", "description": "Full name of the applicant." },
                        title: { "type": "STRING", "description": "Current or desired professional title." },
                        contact: {
                            type: "OBJECT",
                            properties: {
                                phone: { "type": "STRING" },
                                email: { "type": "STRING" },
                                linkedin: { "type": "STRING", "description": "LinkedIn profile URL or handle." }
                            }
                        },
                        summary: { "type": "STRING", "description": "A concise, 3-4 sentence professional summary." },
                        experience: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    title: { "type": "STRING" },
                                    company: { "type": "STRING" },
                                    dates: { "type": "STRING", "description": "e.g., 'Jan 2020 - Dec 2023' or '2020 - Present'" },
                                    description: { "type": "STRING", "description": "A 2-3 line summary of key achievement or responsibility." }
                                }
                            }
                        },
                        education: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    degree: { "type": "STRING" },
                                    institution: { "type": "STRING" },
                                    dates: { "type": "STRING", "description": "e.g., '2015 - 2019'" }
                                }
                            }
                        },
                        skills: { "type": "ARRAY", items: { "type": "STRING" }, "description": "List of 5-10 core technical and soft skills." }
                    },
                    propertyOrdering: ["name", "title", "contact", "summary", "experience", "education", "skills"]
                },
                templates: {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            id: { "type": "STRING", "description": "A unique identifier: 'classic', 'modern', or 'tech'." },
                            name: { "type": "STRING", "description": "A catchy name for the template, e.g., 'The Clarity Standard'." },
                            description: { "type": "STRING", "description": "A brief, one-sentence description of who the template is best for (e.g., 'Best for finance and legal professionals.')." }
                        }
                    }
                }
            },
            propertyOrdering: ["parsedData", "templates"]
        };

        // --- DATA STRUCTURES ---

        const TEMPLATE_DESIGNS = {
            classic: 'The Clarity Standard',
            modern: 'Modern Professional',
            tech: 'Tech Streamlined',
        };

        // Default empty data structure (used for initial load)
        const DEFAULT_RESUME_DATA = {
            name: 'Jane Doe',
            title: 'Senior Product Manager',
            contact: { phone: '123-456-7890', email: 'jane.doe@example.com', linkedin: 'linkedin.com/in/janedoe' },
            summary: 'A highly motivated and results-oriented professional with 8+ years of experience in product development, agile methodologies, and cross-functional team leadership. Proven ability to drive product strategy from concept to launch.',
            experience: [
                { title: 'Product Manager', company: 'Innovate Solutions', dates: 'Jan 2020 - Present', description: 'Led the development of a flagship SaaS platform, resulting in a 40% increase in user retention. Managed a team of 5 engineers and 2 designers.' }
            ],
            education: [
                { degree: 'MBA in Business Administration', institution: 'State University', dates: '2014 - 2016' }
            ],
            skills: ['Agile/Scrum', 'Product Strategy', 'Figma', 'SQL', 'Market Analysis', 'Team Leadership']
        };


        // --- RESUME TEMPLATES (COMPONENTS) ---

        const SectionHeader = ({ icon: Icon, title, isDark = false }) => (
            <div className={`flex items-center space-x-2 pb-1 mb-2 ${isDark ? 'border-b-2 border-white/50 text-white' : 'border-b-2 border-slate-300 text-slate-700'}`}>
                <Icon className="w-5 h-5" />
                <h2 className="text-xl font-bold tracking-wider uppercase">{title}</h2>
            </div>
        );

        // Template 1: Classic (Single Column, Serif-inspired)
        const ClassicTemplate = ({ data }) => (
            <div className="resume p-6 max-w-4xl mx-auto shadow-2xl bg-white font-serif text-slate-800 printable" style={{ minHeight: '297mm' }}>
                <header className="text-center mb-6">
                    <h1 className="text-4xl font-extrabold text-slate-900 mb-1">{data.name}</h1>
                    <h2 className="text-xl font-medium text-slate-600 mb-3">{data.title}</h2>
                    <div className="flex justify-center flex-wrap gap-x-4 gap-y-1 text-sm text-slate-600">
                        <span><Smartphone className="inline w-3 h-3 mr-1" />{data.contact.phone}</span>
                        <span><Mail className="inline w-3 h-3 mr-1" />{data.contact.email}</span>
                        <span><Globe className="inline w-3 h-3 mr-1" />{data.contact.linkedin}</span>
                    </div>
                </header>

                <section className="mb-6">
                    <SectionHeader icon={Zap} title="Professional Summary" />
                    <p className="text-sm leading-relaxed italic">{data.summary}</p>
                </section>

                <section className="mb-6">
                    <SectionHeader icon={Briefcase} title="Experience" />
                    {data.experience.map((job, index) => (
                        <div key={index} className="mb-3 pl-1">
                            <div className="flex justify-between items-baseline">
                                <h3 className="text-md font-bold">{job.title}</h3>
                                <span className="text-sm font-medium text-slate-500">{job.dates}</span>
                            </div>
                            <p className="text-sm italic text-slate-600 mb-1">{job.company}</p>
                            <p className="text-sm">{job.description}</p>
                        </div>
                    ))}
                </section>

                <div className="flex space-x-6">
                    <section className="w-2/3">
                        <SectionHeader icon={GraduationCap} title="Education" />
                        {data.education.map((edu, index) => (
                            <div key={index} className="mb-3 pl-1">
                                <div className="flex justify-between items-baseline">
                                    <h3 className="text-md font-bold">{edu.degree}</h3>
                                    <span className="text-sm font-medium text-slate-500">{edu.dates}</span>
                                </div>
                                <p className="text-sm italic text-slate-600">{edu.institution}</p>
                            </div>
                        ))}
                    </section>
                    <section className="w-1/3">
                        <SectionHeader icon={CheckCircle} title="Skills" />
                        <ul className="text-sm space-y-1 list-disc list-inside">
                            {data.skills.map((skill, index) => (
                                <li key={index} className="ml-2">{skill}</li>
                            ))}
                        </ul>
                    </section>
                </div>
            </div>
        );

        // Template 2: Modern (Two Column, Sans-Serif, Highlighted Sidebar)
        const ModernTemplate = ({ data }) => (
            <div className="resume p-0 max-w-4xl mx-auto shadow-2xl bg-white font-sans text-slate-800 flex printable" style={{ minHeight: '297mm' }}>
                {/* Sidebar */}
                <div className="w-1/3 p-6 bg-slate-800 text-white rounded-l-lg space-y-6">
                    <header className="text-center pb-4 border-b border-white/30">
                        <h1 className="text-3xl font-extrabold mb-1">{data.name.toUpperCase()}</h1>
                        <p className="text-lg font-light text-cyan-300">{data.title}</p>
                    </header>

                    <section>
                        <SectionHeader icon={Smartphone} title="Contact" isDark={true} />
                        <ul className="text-sm space-y-2 font-light">
                            <li className="flex items-center space-x-2"><Mail className="w-4 h-4 text-cyan-300" /><span>{data.contact.email}</span></li>
                            <li className="flex items-center space-x-2"><Smartphone className="w-4 h-4 text-cyan-300" /><span>{data.contact.phone}</span></li>
                            <li className="flex items-center space-x-2"><Globe className="w-4 h-4 text-cyan-300" /><span>{data.contact.linkedin}</span></li>
                        </ul>
                    </section>

                    <section>
                        <SectionHeader icon={CheckCircle} title="Skills" isDark={true} />
                        <ul className="text-sm space-y-1 font-light">
                            {data.skills.map((skill, index) => (
                                <li key={index} className="text-gray-300">â–¹ {skill}</li>
                            ))}
                        </ul>
                    </section>

                    <section>
                        <SectionHeader icon={GraduationCap} title="Education" isDark={true} />
                        {data.education.map((edu, index) => (
                            <div key={index} className="mb-3">
                                <p className="font-semibold text-base text-cyan-300">{edu.degree}</p>
                                <p className="text-sm text-white/80">{edu.institution}</p>
                                <p className="text-xs text-white/50">{edu.dates}</p>
                            </div>
                        ))}
                    </section>
                </div>

                {/* Main Content */}
                <div className="w-2/3 p-6 space-y-6">
                    <section>
                        <SectionHeader icon={Zap} title="Summary" />
                        <p className="text-base text-gray-700">{data.summary}</p>
                    </section>

                    <section>
                        <h2 className="text-xl font-bold mb-3 uppercase border-b border-slate-300 text-slate-700 flex items-center"><Briefcase className="w-5 h-5 mr-2" />Professional Experience</h2>
                        {data.experience.map((job, index) => (
                            <div key={index} className="mb-4">
                                <div className="flex justify-between items-start">
                                    <h3 className="text-lg font-bold text-slate-900">{job.title} <span className="text-base font-semibold text-cyan-600">| {job.company}</span></h3>
                                    <span className="text-sm font-medium text-slate-500">{job.dates}</span>
                                </div>
                                <p className="text-sm mt-1 leading-relaxed">{job.description}</p>
                            </div>
                        ))}
                    </section>
                </div>
            </div>
        );

        // Template 3: Tech Streamlined (Emphasis on Achievements)
        const TechTemplate = ({ data }) => (
            <div className="resume p-8 max-w-4xl mx-auto shadow-2xl bg-white font-sans text-slate-900 printable" style={{ minHeight: '297mm' }}>
                <header className="flex justify-between items-center mb-6 pb-2 border-b-4 border-indigo-600">
                    <div>
                        <h1 className="text-4xl font-extrabold text-indigo-800">{data.name}</h1>
                        <p className="text-xl font-medium text-slate-600">{data.title}</p>
                    </div>
                    <div className="text-right text-sm space-y-1">
                        <p><Mail className="inline w-4 h-4 mr-1 text-indigo-500" />{data.contact.email}</p>
                        <p><Smartphone className="inline w-4 h-4 mr-1 text-indigo-500" />{data.contact.phone}</p>
                        <p><Globe className="inline w-4 h-4 mr-1 text-indigo-500" />{data.contact.linkedin}</p>
                    </div>
                </header>

                <section className="mb-6">
                    <h2 className="text-xl font-bold mb-2 uppercase border-b border-indigo-300 text-indigo-600">Profile</h2>
                    <p className="text-base">{data.summary}</p>
                </section>

                <div className="grid grid-cols-4 gap-6">
                    <div className="col-span-3 space-y-6">
                        <section>
                            <h2 className="text-xl font-bold mb-3 uppercase border-b border-indigo-300 text-indigo-600 flex items-center"><Briefcase className="w-5 h-5 mr-2" />Professional Experience</h2>
                            {data.experience.map((job, index) => (
                                <div key={index} className="mb-4">
                                    <div className="flex justify-between items-start">
                                        <h3 className="text-lg font-bold">{job.title}</h3>
                                        <span className="text-sm font-medium text-slate-600">{job.dates}</span>
                                    </div>
                                    <p className="text-md font-medium italic text-slate-700 mb-1">{job.company}</p>
                                    <ul className="list-disc list-inside text-sm space-y-1 ml-4">
                                        <li>{job.description}</li>
                                    </ul>
                                </div>
                            ))}
                        </section>
                    </div>
                    <div className="col-span-1 space-y-6">
                        <section>
                            <h2 className="text-xl font-bold mb-3 uppercase border-b border-indigo-300 text-indigo-600 flex items-center"><CheckCircle className="w-5 h-5 mr-2" />Skills</h2>
                            <ul className="text-sm space-y-1">
                                {data.skills.map((skill, index) => (
                                    <li key={index} className="py-0.5 px-2 bg-indigo-100 text-indigo-700 rounded-full text-center">{skill}</li>
                                ))}
                            </ul>
                        </section>
                        <section>
                            <h2 className="text-xl font-bold mb-3 uppercase border-b border-indigo-300 text-indigo-600 flex items-center"><GraduationCap className="w-5 h-5 mr-2" />Education</h2>
                            {data.education.map((edu, index) => (
                                <div key={index} className="mb-3">
                                    <p className="font-semibold text-base">{edu.degree}</p>
                                    <p className="text-sm text-slate-700">{edu.institution}</p>
                                    <p className="text-xs text-slate-500">{edu.dates}</p>
                                </div>
                            ))}
                        </section>
                    </div>
                </div>
            </div>
        );


        // --- MAIN APPLICATION COMPONENT ---

        const App = () => {
            const [uploadedFile, setUploadedFile] = useState(null);
            const [base64Content, setBase64Content] = useState(null); // Used for images and TXT content
            const [fileType, setFileType] = useState(null);
            const [resumeData, setResumeData] = useState(DEFAULT_RESUME_DATA);
            const [templates, setTemplates] = useState([]);
            const [selectedTemplate, setSelectedTemplate] = useState('modern');
            const [step, setStep] = useState(1); // 1: Input, 2: Select/Edit, 3: Preview/Download
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);

            // Converts File to Base64 (for images) or plain text (for TXT)
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setUploadedFile(file);
                setFileType(file.type);
                setError(null);

                const reader = new FileReader();

                if (file.type.startsWith('image/')) {
                    // Read image files as base64
                    reader.onload = (e) => {
                        const base64 = e.target.result.split(',')[1];
                        setBase64Content(base64);
                    };
                    reader.readAsDataURL(file);
                } else if (file.name.endsWith('.txt')) {
                    // Read text files as plain text
                    reader.onload = (e) => {
                        setBase64Content(e.target.result); // Store text in base64Content state for API simplicity
                    };
                    reader.readAsText(file);
                } else {
                    setError('Unsupported file type. Please upload a .txt file or a screenshot/image (.jpg, .png) of your resume.');
                    setUploadedFile(null);
                    setBase64Content(null);
                }
            };

            const handleGenerate = useCallback(async () => {
                if (!base64Content) {
                    setError('Please upload a resume file (TXT or Image) to begin analysis.');
                    return;
                }

                setIsLoading(true);
                setError(null);
                let retries = 0;
                const maxRetries = 3;
                
                const systemPrompt = "You are an expert ATS (Applicant Tracking System) and resume formatting AI. Analyze the provided resume content (which may be text or an image/screenshot of a document). Extract all relevant information (name, contact, summary, experience, education, skills). Structure this data into the requested JSON schema. Additionally, propose three distinct, modern, ATS-friendly resume template options based on the applicant's inferred career stage and industry. The templates MUST have IDs 'classic', 'modern', and 'tech'.";
                
                const parts = [];
                
                if (fileType.startsWith('image/')) {
                    // Multimodal input: Text prompt + Image data
                    parts.push({ text: "Analyze the attached image and extract the resume data." });
                    parts.push({
                        inlineData: {
                            mimeType: fileType,
                            data: base64Content
                        }
                    });
                } else {
                    // Text input: Send the content directly
                    parts.push({ text: base64Content });
                    parts.push({ text: "Analyze this raw text and extract the resume data." });
                }

                const payload = {
                    contents: [{ parts: parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: RESUME_SCHEMA
                    }
                };

                const executeFetch = async () => {
                    const url = `${API_URL}?key=${apiKey}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        console.error("API response status:", response.status, await response.text());
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        console.error("AI returned empty text content.");
                        throw new Error("Received empty content from the AI model.");
                    }

                    // The model returns a stringified JSON object
                    const parsedResponse = JSON.parse(jsonText);
                    
                    // CRITICAL VALIDATION: Ensure the response structure is correct
                    if (!parsedResponse.parsedData || !Array.isArray(parsedResponse.templates)) {
                        console.error("AI response missing required structured keys:", parsedResponse);
                        throw new Error("AI returned data but was unable to structure the resume sections correctly. Please try again or simplify your input image/text.");
                    }

                    // Set state based on the structured response
                    const data = parsedResponse.parsedData;
                    const tpls = parsedResponse.templates;
                    
                    // Map the parsed templates back to the known names for UI consistency
                    const finalTemplates = tpls.map(t => ({
                        ...t,
                        name: TEMPLATE_DESIGNS[t.id] || t.name // Use local name if available
                    }));

                    setResumeData(data);
                    setTemplates(finalTemplates);
                    setStep(2); // Move to selection step
                    setIsLoading(false);
                };

                while (retries < maxRetries) {
                    try {
                        await executeFetch();
                        return;
                    } catch (err) {
                        console.error(`Attempt ${retries + 1} failed:`, err);
                        retries++;
                        if (retries < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, retries) * 1000)); // Exponential backoff
                        } else {
                            setError('Failed to analyze the resume after multiple attempts. Please check the file format or try again later.');
                            setIsLoading(false);
                        }
                    }
                }
            }, [base64Content, fileType]);

            // Handle template selection and move to preview/edit
            const handleTemplateSelect = (id) => {
                setSelectedTemplate(id);
                setStep(3);
            };

            // Render the selected resume template
            const RenderResume = useMemo(() => {
                switch (selectedTemplate) {
                    case 'classic':
                        return ClassicTemplate;
                    case 'modern':
                    case 'default':
                        return ModernTemplate;
                    case 'tech':
                        return TechTemplate;
                    default:
                        return ModernTemplate;
                }
            }, [selectedTemplate]);

            // Custom function for the download/print feature
            const handleDownload = () => {
                const resumeElement = document.querySelector('.resume.printable');
                if (!resumeElement) {
                    // Use custom modal instead of alert
                    setError('Cannot find resume content to print. Please ensure a template is selected.');
                    return;
                }

                // Apply temporary print styles
                const printContent = resumeElement.outerHTML;

                // Create temporary window content with only the resume
                const printWindow = window.open('', '', 'height=600,width=800');
                printWindow.document.write('<html><head><title>Resume Download</title>');
                printWindow.document.write('<script src="https://cdn.tailwindcss.com"></script>');
                printWindow.document.write('<style>');
                printWindow.document.write('@media print {');
                printWindow.document.write('.printable { max-width: 210mm; margin: 0; padding: 0; box-shadow: none; }');
                printWindow.document.write('body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }');
                printWindow.document.write('}');
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(printContent);
                printWindow.document.write('</body></html>');
                printWindow.document.close();

                // Wait for styles to load, then print
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            };


            // Helper component for the wizard steps
            const StepIndicator = ({ num, title, currentStep }) => (
                <div className="flex flex-col items-center">
                    <div className={`w-10 h-10 flex items-center justify-center rounded-full font-bold transition-colors duration-300 ${currentStep === num ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'}`}>
                        {num}
                    </div>
                    <span className={`mt-2 text-sm text-center ${currentStep >= num ? 'text-indigo-700 font-semibold' : 'text-gray-500'}`}>{title}</span>
                </div>
            );

            const FileNameDisplay = () => {
                if (!uploadedFile) return <span className="text-gray-500">No file selected.</span>;
                
                let Icon = FileText;
                if (fileType.startsWith('image/')) {
                    Icon = ImageIcon;
                }

                return (
                    <div className="flex items-center space-x-2 text-indigo-700 font-medium">
                        <Icon className="w-5 h-5" />
                        <span>{uploadedFile.name} ({uploadedFile.type.replace('image/', '').toUpperCase()})</span>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 md:p-8 font-sans">
                    <div className="max-w-7xl mx-auto">
                        <header className="text-center mb-10">
                            <h1 className="text-4xl font-extrabold text-indigo-800">AI Resume Redesigner</h1>
                            <p className="text-xl text-gray-600 mt-2">Upload your old resume, analyze the content, and apply a modern design.</p>
                        </header>

                        <div className="flex justify-between max-w-2xl mx-auto mb-10">
                            <StepIndicator num={1} title="Upload Resume" currentStep={step} />
                            <div className="w-1/4 border-t-2 border-gray-300 mt-5"></div>
                            <StepIndicator num={2} title="Select Template" currentStep={step} />
                            <div className="w-1/4 border-t-2 border-gray-300 mt-5"></div>
                            <StepIndicator num={3} title="Preview & Download" currentStep={step} />
                        </div>

                        {error && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 max-w-4xl mx-auto" role="alert">
                                <strong className="font-bold">Error:</strong>
                                <span className="block sm:inline ml-2">{error}</span>
                                <button onClick={() => setError(null)} className="ml-4 text-red-700 font-semibold hover:text-red-900">Close</button>
                            </div>
                        )}

                        {/* --- STEP 1: INPUT --- */}
                        {step === 1 && (
                            <div className="bg-white p-6 md:p-10 shadow-xl rounded-2xl max-w-4xl mx-auto">
                                <h2 className="text-2xl font-bold mb-4 text-indigo-700 flex items-center"><UploadCloud className="w-6 h-6 mr-2" /> 1. Upload Your Existing Resume</h2>
                                <p className="mb-6 text-gray-600">Upload a plain text file (**.txt**) or an **image/screenshot** (**.jpg**, **.png**) of your resume. The AI will read the content and structure it automatically.</p>
                                
                                <div className="relative border-2 border-dashed border-gray-300 p-10 rounded-xl hover:border-indigo-500 transition duration-200">
                                    <input
                                        type="file"
                                        accept=".txt, image/png, image/jpeg, image/webp"
                                        onChange={handleFileChange}
                                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                    />
                                    <div className="text-center">
                                        <UploadCloud className="w-12 h-12 mx-auto text-gray-400" />
                                        <p className="mt-2 text-sm text-gray-600">
                                            <span className="font-semibold text-indigo-600">Click to upload</span> or drag and drop
                                        </p>
                                        <p className="text-xs text-gray-500 mt-1">TXT, JPG, PNG, WEBP (Max 5MB)</p>
                                    </div>
                                </div>

                                <div className="mt-4 flex justify-between items-center">
                                    <FileNameDisplay />
                                    <button
                                        onClick={handleGenerate}
                                        disabled={isLoading || !base64Content}
                                        className="flex items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-200 disabled:bg-indigo-300 shadow-lg"
                                    >
                                        {isLoading ? (
                                            <>
                                                <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                                Analyzing Content...
                                            </>
                                        ) : (
                                            <>
                                                <Send className="w-5 h-5 mr-2" />
                                                Analyze & Suggest Designs
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* --- STEP 2: TEMPLATE SELECTION --- */}
                        {step === 2 && (
                            <div className="bg-white p-6 md:p-10 shadow-xl rounded-2xl max-w-4xl mx-auto">
                                <h2 className="text-2xl font-bold mb-6 text-indigo-700 flex items-center"><Edit className="w-6 h-6 mr-2" /> 2. Review Data & Select a Template</h2>
                                <div className="grid md:grid-cols-3 gap-6">
                                    {templates.map((tpl) => (
                                        <div
                                            key={tpl.id}
                                            onClick={() => handleTemplateSelect(tpl.id)}
                                            className={`p-6 border-2 rounded-xl cursor-pointer transition duration-200 shadow-md flex flex-col justify-between 
                                                        ${selectedTemplate === tpl.id ? 'border-indigo-600 ring-4 ring-indigo-200' : 'border-gray-200 hover:border-indigo-500'}`}
                                        >
                                            <div>
                                                <h3 className="text-xl font-bold text-indigo-600 mb-2">{tpl.name}</h3>
                                                <p className="text-sm text-gray-600 mb-4">{tpl.description}</p>
                                            </div>
                                            <button className="w-full py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600">
                                                Select Template
                                            </button>
                                        </div>
                                    ))}
                                </div>
                                
                                <div className="mt-8 pt-6 border-t border-gray-200">
                                    <h3 className="text-xl font-bold mb-3 text-gray-800">Parsed Summary (for quick check):</h3>
                                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm">
                                        <p><span className="font-semibold">Name:</span> {resumeData.name}</p>
                                        <p><span className="font-semibold">Title:</span> {resumeData.title}</p>
                                        <p><span className="font-semibold">Experience Count:</span> {resumeData.experience.length}</p>
                                        <p><span className="font-semibold">Skills:</span> {resumeData.skills.slice(0, 5).join(', ')}...</p>
                                        <p className="mt-2 text-xs text-gray-500">
                                            <span className="font-semibold">Tip:</span> The AI has successfully parsed the core data. Proceed to select a design.
                                        </p>
                                    </div>
                                </div>

                                <div className="flex justify-between mt-6">
                                    <button
                                        onClick={() => setStep(1)}
                                        className="flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-200"
                                    >
                                        Back to Upload
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* --- STEP 3: PREVIEW AND DOWNLOAD --- */}
                        {step === 3 && (
                            <div className="max-w-5xl mx-auto">
                                <div className="flex justify-between items-center mb-6 px-4">
                                    <h2 className="text-2xl font-bold text-indigo-700 flex items-center">
                                        <Printer className="w-6 h-6 mr-2" /> 3. Final Preview: {TEMPLATE_DESIGNS[selectedTemplate]}
                                    </h2>
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={() => setStep(2)}
                                            className="flex items-center px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-200"
                                        >
                                            <Edit className="w-4 h-4 mr-2" />
                                            Change Template
                                        </button>
                                        <button
                                            onClick={handleDownload}
                                            className="flex items-center px-6 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition duration-200 shadow-lg"
                                        >
                                            <Download className="w-5 h-5 mr-2" />
                                            Download / Print PDF
                                        </button>
                                    </div>
                                </div>

                                {/* Resume Canvas Area */}
                                <div className="p-4 bg-gray-200 rounded-xl overflow-x-auto shadow-inner">
                                    <RenderResume data={resumeData} />
                                </div>

                                <p className="text-center text-sm text-gray-500 mt-4">
                                    Note: Use the "Download / Print PDF" button and select "Save as PDF" in your browser's print dialog for the final file.
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the App component into the root element
        const container = document.getElementById('root');
        if (container) {
            ReactDOM.createRoot(container).render(<App />);
        }
    </script>
</body>
</html>

